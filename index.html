<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>iHeart Now Playing — Live Metadata</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Roboto Condensed -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@300;400;700&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      font-family: "Roboto Condensed", sans-serif;
      background: #0b0f14;
      color: #e7eef7;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      padding: 24px;
    }
    .app {
      background: #121821;
      padding: 20px;
      border-radius: 12px;
      width: 95%;
      max-width: 900px;
      box-shadow: 0 0 20px rgba(0,0,0,0.4);
    }
    h1 {
      margin: 0 0 20px;
      font-size: 28px;
      text-align: center;
    }
    .controls {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
    }
    input[type="number"], button {
      font-family: "Roboto Condensed", sans-serif;
    }
    input[type="number"] {
      padding: 8px;
      font-size: 16px;
      border: 1px solid #444;
      border-radius: 6px;
      background: #0f1520;
      color: #fff;
      width: 200px;
      outline: none;
    }
    button {
      padding: 8px 12px;
      background: #1b62ff;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }
    button:disabled {
      background: #444;
      cursor: not-allowed;
    }
    .meta {
      background: #0f1520;
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
    }
    .meta img {
      width: 150px;
      height: 150px;
      object-fit: cover;
      border-radius: 8px;
      border: 1px solid #444;
      display: block;
      margin-bottom: 10px;
    }
    .explicit {
      background: #2a1a1a;
      color: #ff9a9a;
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
      display: inline-block;
      margin-top: 5px;
    }
    .line {
      margin: 8px 0;
    }
    .label {
      font-weight: bold;
      color: #a9b6c7;
    }
    .value {
      font-size: 18px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="app">
    <h1>iHeart Now Playing</h1>
    <div class="controls">
      <input id="stationId" type="number" value="1701" />
      <button id="startBtn">Start</button>
      <button id="stopBtn" disabled>Stop</button>
    </div>

    <div class="meta">
      <img id="albumImg" src="https://i.iheart.com/v3/re/assets.brands/default" alt="Album Art" />
      <div class="line"><span class="label">Track:</span> <span class="value" id="trackTitle">—</span></div>
      <div class="line"><span class="label">Artist:</span> <span class="value" id="artistName">—</span></div>
      <div class="line"><span class="label">Station:</span> <span class="value" id="stationInfo">—</span></div>
      <div class="line" id="explicitLine" style="display:none;"><span class="explicit">EXPLICIT</span></div>
      <div class="line"><span class="label">Last Updated:</span> <span id="lastUpdated">—</span></div>
      <div class="line"><span class="label">Status:</span> <span id="statusText">Waiting…</span></div>
    </div>
  </div>

  <script>
    const DEFAULT_IMAGE = "https://i.iheart.com/v3/re/assets.brands/default";
    const DEFAULT_TITLE = "iHeart Now Playing — Live Metadata";
    const API_URL = id => `https://us.api.iheart.com/api/v3/live-meta/stream/${id}/currentTrackMeta?defaultMetadata=true`;

    const els = {
      stationId: document.getElementById('stationId'),
      startBtn: document.getElementById('startBtn'),
      stopBtn: document.getElementById('stopBtn'),
      trackTitle: document.getElementById('trackTitle'),
      artistName: document.getElementById('artistName'),
      stationInfo: document.getElementById('stationInfo'),
      albumImg: document.getElementById('albumImg'),
      explicitLine: document.getElementById('explicitLine'),
      lastUpdated: document.getElementById('lastUpdated'),
      statusText: document.getElementById('statusText')
    };

    let timer = null;
    const POLL_INTERVAL = 5000;

    function safeText(val, fallback = "—") {
      if (typeof val === "string" && val.trim()) return val;
      return fallback;
    }

    function updatePageTitle(track, artist) {
      if (track && artist && track !== "—" && artist !== "—") {
        document.title = `${track} – ${artist}`;
      } else {
        document.title = DEFAULT_TITLE;
      }
    }

    function updateInfo(data, id) {
      const tr = data?.track || {};

      const trackName = safeText(tr.trackName);
      const artistName = safeText(tr.artistName);
      els.trackTitle.textContent = trackName;
      els.artistName.textContent = artistName;

      const stationName = safeText(data?.station?.name, null);
      els.stationInfo.textContent = stationName
        ? `${id} – ${stationName}`
        : `Channel ID ${id}`;

      els.explicitLine.style.display = tr.explicit ? "block" : "none";

      els.albumImg.src = tr.albumImageUrl || DEFAULT_IMAGE;
      els.albumImg.onerror = () => (els.albumImg.src = DEFAULT_IMAGE);

      els.lastUpdated.textContent = new Date().toLocaleTimeString();
      els.statusText.textContent = "Updated";

      updatePageTitle(trackName, artistName);
    }

    async function fetchTrack(id) {
      try {
        const res = await fetch(API_URL(id), { cache: "no-store" });
        if (res.status === 204) {
          els.statusText.textContent = "Ad/blank (204 No Content)";
          updatePageTitle();
          return;
        }
        if (!res.ok) {
          els.statusText.textContent = `Error: ${res.status}`;
          updatePageTitle();
          return;
        }
        const data = await res.json();
        updateInfo(data, id);
      } catch (e) {
        console.error(e);
        els.statusText.textContent = "Network error";
        updatePageTitle();
      }
    }

    function startPolling() {
      const id = els.stationId.value.trim();
      if (!id) return;
      els.startBtn.disabled = true;
      els.stopBtn.disabled = false;
      fetchTrack(id);
      timer = setInterval(() => fetchTrack(id), POLL_INTERVAL);
    }

    function stopPolling() {
      clearInterval(timer);
      els.startBtn.disabled = false;
      els.stopBtn.disabled = true;
      els.statusText.textContent = "Polling stopped.";
      updatePageTitle();
    }

    els.startBtn.addEventListener('click', startPolling);
    els.stopBtn.addEventListener('click', stopPolling);

    // Auto-start with default 1701
    startPolling();
  </script>
</body>
</html>
